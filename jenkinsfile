pipeline{
    agent any //selection of agents
    //environment
     environment{
        SONAR_HOME = 'C:\\Users\\Administrator\\Documents\\tools\\sonarscanner\\sonar-scanner-7.1.0.4889-windows-x64\\bin'
        REPO_NAME = 'https://github.com/sinchana9999/html-sample-app-sinchana.git'
        BRANCH_NAME = 'master'
        SONAR_TOKEN = credentials('admintoken')
        DOCKER_CREDS = 'dockersinchana'
        IMAGE_NAME  = "sinchana111/tanwebapp-iis-ltsc2022"
        IMAGE_TAG =  "codev1"
        TRIVY_REPORT = "trivy-sinch-report.txt"
        SONAR_PROJECT_KEY = 'sinchanaapp'
        SONAR_SERVER_NAME = 'sinsonarqube' //name given for the sonarqube link in jenkins manage settings
        TRIVY_PATH = 'C:\\Users\\Administrator\\Documents\\tools\\trivy'
    }
    stages{
        //stage 1
        stage('testing and verify required command'){
            steps{
                echo 'hello world'
                //bat or pwsh
                bat """
                %SONAR_HOME%\\sonar-scanner --version
                echo == checking docker ===>
                docker version
                echo == java version ===>
                java --version
                """
            }
        }

         //git checkout
        stage('takign code of github repo'){
            steps{
                echo 'cloning repo'
                echo 'messageeee'
                git url:"${REPO_NAME}", branch:"${BRANCH_NAME}"
            }
        }

        // doing sast with sonarqube
        stage('SAST with sonar-scanner'){
            steps {
                 echo 'wait for sonar-scanner to finish'
                 // calling plugin
                 script {
                    withSonarQubeEnv("${SONAR_SERVER_NAME}") {
               
                    bat """
                    %SONAR_HOME%\\sonar-scanner \
                    -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=${SONAR_HOST_URL} \
                    -Dsonar.token=${SONAR_TOKEN}
                    """
 
                    }
                }
            }
        }

    // using docker plugins to build container image
        stage('building docker image'){
            steps{
                echo 'starting docker build process'
                script{
                    def imageName = "sinchana111/tanwebapp-iis-ltsc2022"
                    def imageTag = "codev1"
                    docker.build("${imageName}:${imageTag}",".")
                }
                //verify image build
                bat 'docker images | findstr tanwebapp'
            }
        }  

        //add stage to scan using trivy is no high , critical vlne then proceed else stop pipeline
        stage('Scan the image using trivy'){
            steps{
                echo 'start scanning vuln using trivy'
                bat """
                set PATH=%TRIVY_PATH%;%PATH%
                echo PATH in Jenkins: %PATH%
                trivy image ${IMAGE_NAME}:${IMAGE_TAG} --severity HIGH,CRITICAL --format table --report summary -o ${TRIVY_REPORT} --skip-version-check
 
                """
            }    
        }

        //pushing image to docker hub
        stage('Docker hub image push'){
            steps{
                echo 'Pushing image to docker hub'
                script{
                    def imageName = "sinchana111/tanwebapp-iis-ltsc2022"
                    def imageTag = "codev1"
                    def hubcreds = "${DOCKER_CREDS}"
                    docker.withRegistry('https://registry.hub.docker.com', hubcreds){
                         docker.image("${IMAGE_NAME}" + ":" + "${IMAGE_TAG}").push()
                    }
 
                }
            }
        }

        // stage to deply app as container using IIS docker image
        stage('deply app using container image'){
            steps{
                echo 'deploying app using container'
                bat """ 
                docker run -itd --name sinchana -p 1234:80   ${IMAGE_NAME}:${IMAGE_TAG}
                docker ps | findstr tanwebapp
                """
            }
        }
        // implement DAST 
        stage('using zap to do '){
            // only given label agent can run this stage job 
            agent {
                label 'ashu-linux'
            }
            steps {
                git url: "${REPO_NAME}", branch: "${BRANCH_NAME}"
                echo 'usinz zap'
                sh 'docker run -t --rm  ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://172.31.35.197:1234'
            }

        }
     
    }
}